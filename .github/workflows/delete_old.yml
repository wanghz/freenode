name: Delete old migrations

on:
  schedule:
    - cron: '10 15 */3 * *'
  workflow_dispatch:

jobs:
  delete_old_files:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€åˆ†æ”¯
      pull-requests: write  # å…è®¸åˆ›å»ºPR
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿æ–‡ä»¶ä¿®æ”¹æ—¶é—´å‡†ç¡®

      - name: æ¸…ç†è¶…è¿‡60å¤©çš„æ—§è¿ç§»æ–‡ä»¶
        run: |
          # å®šä¹‰ç›®æ ‡ç›®å½•ï¼ˆè¯·ç¡®è®¤è·¯å¾„æ­£ç¡®ï¼‰
          TARGET_DIR="./sub"
          days=3   # ä¸¾ä¾‹ï¼Œè¶…è¿‡7å¤©çš„æ–‡ä»¶
          current_time=$(date +%s)
          threshold=$((current_time - days*24*3600))
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$TARGET_DIR" ]; then
            echo "ç›®å½• $TARGET_DIR ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
            exit 0
          fi
          
          #find "$TARGET_DIR" -type f -mtime +3 -exec rm {} \;
          find "$TARGET_DIR" -type f \
            -print0 | while IFS= read -r -d '' file; do
            commit_time=$(git log -1 --format="%ct" -- "$file")
            if [ -n "$commit_time" ] && [ "$commit_time" -lt "$threshold" ]; then
              echo "$file" 
              rm "$file"
            fi
          done
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ”„ delete outdated [$(date +'%Y-%m-%d %H:%M')]"
          git push
ğŸ”„ Auto update proxies [2025-11-21 15:10] Â· wanghz/Proxify@f56e438
